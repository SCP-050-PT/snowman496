<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–Ω–µ–≥–æ–≤–∏–∫ 496 –®–∫–æ–ª–∞ - –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π AR</title>
    
    <!-- –ú–µ—Ç–∞-—Ç–µ–≥–∏ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="–°–Ω–µ–≥–æ–≤–∏–∫ AR">
    <meta name="theme-color" content="#0a3d62">
    <meta name="description" content="–ù–æ–≤–æ–≥–æ–¥–Ω–µ–µ AR-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ñ–æ—Ç–æ —Å —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ —Å–Ω–µ–≥–∞">
    
    <!-- Favicon —Å —ç–º–æ–¥–∑–∏ —Å–Ω–µ–≥–æ–≤–∏–∫–∞ ‚õÑ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>&#9924;</text></svg>">
    
    <style>
        :root {
            --fab-size: 56px;
            --fab-gap: 12px;
            --glass-bg: rgba(0, 0, 0, 0.4);
            --glass-brd: rgba(255, 255, 255, 0.2);
            --glass-on: rgba(74, 105, 189, 0.8);
            --ground-offset: 0px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        #wrap {
            position: fixed;
            inset: 0;
        }

        video, canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        video {
            z-index: 1;
        }

        canvas {
            z-index: 2;
        }

        /* –°–Ω–µ–≥–æ–≤–∏–∫ - —É–≤–µ–ª–∏—á–µ–Ω –Ω–∞ 50% */
        #snowman {
            position: absolute;
            left: 20px;
            bottom: 120px;
            z-index: 5;
            display: none;
            width: 225px; /* –ë—ã–ª–æ 150px, —É–≤–µ–ª–∏—á–µ–Ω–æ –Ω–∞ 50% */
            max-width: 430px;
            touch-action: none;
            user-select: none;
            cursor: grab;
            --tx: 0px;
            --ty: 0px;
            --s: 1;
            transform: translate(var(--tx), var(--ty)) scale(var(--s));
            transform-origin: center center;
            transition: opacity 0.5s ease;
        }

        #snowman.dragging {
            cursor: grabbing;
        }

        #snowman img {
            display: block;
            width: 100%;
            height: auto;
            pointer-events: none;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –º–∞—Å—à—Ç–∞–±–∞ */
        .scale-indicator {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
        }

        /* –≠–∫—Ä–∞–Ω —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è */
        #permission-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a3d62 0%, #1e3c72 100%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: white;
            text-align: center;
            transition: opacity 0.5s ease;
        }

        #permission-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .snowman-icon {
            width: 120px;
            height: 120px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 40px;
            line-height: 1.4;
        }

        #start-btn {
            background: #4a69bd;
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(74, 105, 189, 0.4);
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        #start-btn:hover, #start-btn:active {
            background: #3c5aa8;
            transform: scale(1.05);
        }

        #start-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .permission-note {
            font-size: 14px;
            opacity: 0.6;
            margin-top: 30px;
            max-width: 300px;
            line-height: 1.4;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loader {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
        }

        .loader.active {
            display: block;
        }

        /* –ë—Ä–µ–Ω–¥ –∏ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        #brand {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 18px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 6;
            user-select: none;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 20px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            display: none;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            z-index: 7;
            left: 50%;
            transform: translateX(-50%);
            gap: var(--fab-gap);
            display: none;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 100%;
            padding: 0 10px;
        }

        /* –ö–Ω–æ–ø–∫–∏ —Å —ç–º–æ–¥–∑–∏ */
        .fab {
            position: relative;
            width: var(--fab-size);
            height: var(--fab-size);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--glass-bg);
            border: 1px solid var(--glass-brd);
            backdrop-filter: blur(10px);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 28px;
            opacity: 1;
            transition: opacity 0.3s ease, transform 0.2s ease;
        }

        .fab:active {
            transform: scale(0.95);
        }

        .fab.is-on {
            background: var(--glass-on);
            box-shadow: 0 4px 12px rgba(74, 105, 189, 0.4);
        }

        .fab:hover {
            filter: brightness(1.2);
        }

        .fab.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #shotBtn {
            background: rgba(255, 71, 87, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        #shotBtn:hover {
            background: rgba(255, 71, 87, 1);
        }

        /* –ü—Ä–µ–ª–æ–∞–¥–µ—Ä –¥–ª—è —Ñ–æ—Ç–æ */
        #photo-preview {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #preview-image {
            max-width: 90%;
            max-height: 70%;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
        }

        .preview-controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }

        .preview-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        #save-btn {
            background: #4a69bd;
            color: white;
        }

        #cancel-btn {
            background: #666;
            color: white;
        }

        /* –í—Å–ø—ã—à–∫–∞ */
        #flash {
            position: fixed;
            inset: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 8;
            transition: opacity 0.3s ease;
        }

        #flash.active {
            opacity: 0.8;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 480px) {
            .fab {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
            
            #controls {
                gap: 10px;
                bottom: 15px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .snowman-icon {
                width: 100px;
                height: 100px;
                font-size: 50px;
            }
            
            /* –°–Ω–µ–≥–æ–≤–∏–∫ –∞–¥–∞–ø—Ç–∏–≤–µ–Ω */
            #snowman {
                width: 180px; /* –£–º–µ–Ω—å—à–∞–µ–º –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö, –Ω–æ –≤—Å—ë –µ—â—ë –±–æ–ª—å—à–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ */
            }
        }

        @media (max-width: 360px) {
            .fab {
                width: 46px;
                height: 46px;
                font-size: 22px;
            }
            
            #controls {
                gap: 8px;
            }
            
            #snowman {
                width: 160px;
            }
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ -->
    <div id="permission-screen">
        <div class="snowman-icon">‚õÑ</div>
        <h1>–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –°–Ω–µ–≥–æ–≤–∏–∫</h1>
        <div class="subtitle">–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —Å–Ω–µ–≥–æ–≤–∏–∫–∞<br>–∏ —Å–¥–µ–ª–∞–π –Ω–æ–≤–æ–≥–æ–¥–Ω–µ–µ —Ñ–æ—Ç–æ!</div>
        <button id="start-btn">–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ</button>
        <div class="permission-note">
            –î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.
            –ú—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—ë–º –≤–∞—à–∏ —Ñ–æ—Ç–æ.
        </div>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loader" class="loader">
        <div style="font-size: 30px; margin-bottom: 10px;">‚õÑ</div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <!-- –ü—Ä–µ–ª–æ–∞–¥–µ—Ä —Ñ–æ—Ç–æ -->
    <div id="photo-preview">
        <img id="preview-image" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ">
        <div class="preview-controls">
            <button id="save-btn" class="preview-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
            <button id="cancel-btn" class="preview-btn">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div id="wrap">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas"></canvas>
        <div id="snowman">
            <img id="snowmanImg" src="assets/snowman.gif" alt="–°–Ω–µ–≥–æ–≤–∏–∫" draggable="false">
            <div class="scale-indicator">100%</div>
        </div>
    </div>

    <!-- –í—Å–ø—ã—à–∫–∞ –¥–ª—è —Ñ–æ—Ç–æ -->
    <div id="flash"></div>
    
    <!-- –ë—Ä–µ–Ω–¥ -->
    <div id="brand">snowman496school.ru</div>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div id="controls" aria-label="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
        <button id="btnSnow" class="fab is-on" type="button" aria-pressed="true" title="–°–Ω–µ–≥">
            ‚ùÑÔ∏è
        </button>
        
        <button id="btnSnowman" class="fab is-on" type="button" aria-pressed="true" title="–°–Ω–µ–≥–æ–≤–∏–∫">
            ‚õÑ
        </button>
        
        <button id="btnMusic" class="fab" type="button" aria-pressed="false" title="–ú—É–∑—ã–∫–∞">
            üéµ
        </button>
        
        <button id="btnDrifts" class="fab" type="button" aria-pressed="false" title="–°—É–≥—Ä–æ–±—ã">
            üèîÔ∏è
        </button>
        
        <button id="btnPlow" class="fab is-on" type="button" aria-pressed="true" title="–ê–≤—Ç–æ–ø—Ä–æ–µ–∑–¥ –º–∞—à–∏–Ω—ã">
            üöú
        </button>
        
        <button id="shotBtn" class="fab" type="button" title="–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ">
            üì∏
        </button>
    </div>

    <script>
        'use strict';

        /* ========== –£–õ–£–ß–®–ï–ù–ò–ï 1: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ========== */
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isLowEndDevice = (() => {
            if (!isMobile) return false;
            const memory = navigator.deviceMemory || 4;
            const cores = navigator.hardwareConcurrency || 4;
            return memory < 4 || cores < 4;
        })();

        /* ========== –°–°–´–õ–ö–ò –ù–ê –≠–õ–ï–ú–ï–ù–¢–´ ========== */
        const startBtn = document.getElementById('start-btn');
        const shotBtn = document.getElementById('shotBtn');
        const btnSnow = document.getElementById('btnSnow');
        const btnSnowman = document.getElementById('btnSnowman');
        const btnMusic = document.getElementById('btnMusic');
        const btnDrifts = document.getElementById('btnDrifts');
        const btnPlow = document.getElementById('btnPlow');
        const controls = document.getElementById('controls');
        const flash = document.getElementById('flash');
        const brand = document.getElementById('brand');
        const permissionScreen = document.getElementById('permission-screen');
        const loader = document.getElementById('loader');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { alpha: true });
        const snowman = document.getElementById('snowman');
        const snowmanImg = document.getElementById('snowmanImg');
        const photoPreview = document.getElementById('photo-preview');
        const previewImage = document.getElementById('preview-image');
        const saveBtn = document.getElementById('save-btn');
        const cancelBtn = document.getElementById('cancel-btn');

        const DPR = Math.min(window.devicePixelRatio || 1, isLowEndDevice ? 1 : 2);
        const CAPTURE_DPR = isLowEndDevice ? 1 : DPR;

        /* ========== –£–õ–£–ß–®–ï–ù–ò–ï 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ========== */
        let running = false;
        let state = {
            snowEnabled: true,
            snowmanEnabled: true,
            musicEnabled: false,
            driftsEnabled: false,
            plowAutoEnabled: true,
            scale: 1.5, // –ù–∞—á–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± —Å–Ω–µ–≥–æ–≤–∏–∫–∞ —É–≤–µ–ª–∏—á–µ–Ω –Ω–∞ 50%
            lastCamera: 'environment'
        };

        function loadSettings() {
            try {
                const saved = localStorage.getItem('snowmanAR_settings');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    Object.assign(state, loaded);
                    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', state);
                }
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:', e);
            }
        }

        function saveSettings() {
            try {
                localStorage.setItem('snowmanAR_settings', JSON.stringify(state));
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:', e);
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadSettings();

        /* ========== –ú–£–ó–´–ö–ê –° –ò–ù–î–ò–ö–ê–¢–û–†–û–ú –ó–ê–ì–†–£–ó–ö–ò ========== */
        let bgm = null;
        
        function initAudio() {
            if (bgm) return;
            
            loader.classList.add('active');
            loader.innerHTML = '<div style="font-size: 30px; margin-bottom: 10px;">üéµ</div><div>–ó–∞–≥—Ä—É–∑–∫–∞ –º—É–∑—ã–∫–∏...</div>';
            
            bgm = new Audio();
            bgm.loop = true;
            bgm.preload = 'auto';
            bgm.src = 'assets/song.mp3';
            bgm.volume = 0.5;
            
            bgm.addEventListener('canplaythrough', () => {
                loader.classList.remove('active');
                console.log('–ú—É–∑—ã–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            });
            
            bgm.addEventListener('error', () => {
                loader.classList.remove('active');
                console.warn('–ú—É–∑—ã–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            });
        }
        
        async function toggleMusic() {
            if (!bgm) {
                initAudio();
                // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            state.musicEnabled = !state.musicEnabled;
            btnMusic.classList.toggle('is-on', state.musicEnabled);
            btnMusic.setAttribute('aria-pressed', String(state.musicEnabled));
            saveSettings();
            
            try {
                if (state.musicEnabled) {
                    await bgm.play();
                } else {
                    bgm.pause();
                    bgm.currentTime = 0;
                }
            } catch (err) {
                console.warn('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –º—É–∑—ã–∫–∏:', err);
                state.musicEnabled = false;
                btnMusic.classList.remove('is-on');
            }
        }

        /* ========== –£–õ–£–ß–®–ï–ù–ò–ï 4: –£—Ç–∏–ª–∏—Ç—ã ========== */
        function cssPx(varName, fallback) {
            const v = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
            const m = /(-?\d+(\.\d+)?)px/.exec(v);
            return m ? parseFloat(m[1]) : fallback;
        }

        /* ========== –£–õ–£–ß–®–ï–ù–ò–ï 5: –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Å–Ω–µ–≥ ========== */
        let flakes = [];
        let sprites = [];
        let heightmap = [];
        let binW = 4;
        let bins = 0;
        let groundY = 0;
        const spray = [];
        let nextPlowTimer = null;

        // –¢–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–µ —Å–Ω–µ–∂–∏–Ω–∫–∏ (—É–±—Ä–∞–Ω—ã –∑–≤–µ–∑–¥–æ—á–∫–∏, —Å–µ—Ä–¥–µ—á–∫–∏, –±—ã—Å—Ç—Ä—ã–µ)
        const flakeTypes = {
            normal: { minSize: 1.4, maxSize: 2.4, speed: 70, sway: 28 }
        };

        function makeFlakeSprite(size) {
            const s = Math.max(10, size | 0);
            const off = document.createElement('canvas');
            off.width = off.height = s;
            const c = off.getContext('2d');
            
            // –ü—Ä–æ—Å—Ç–∞—è —Å–Ω–µ–∂–∏–Ω–∫–∞
            const g = c.createRadialGradient(s/2, s/2, s*0.05, s/2, s/2, s*0.48);
            g.addColorStop(0, 'rgba(255,255,255,.98)');
            g.addColorStop(0.6, 'rgba(255,255,255,.45)');
            g.addColorStop(1, 'rgba(255,255,255,0)');
            c.fillStyle = g;
            c.beginPath();
            c.arc(s/2, s/2, s*0.48, 0, Math.PI*2);
            c.fill();
            
            return off;
        }

        function buildSprites() {
            sprites = [];
            // –¢–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–µ —Å–Ω–µ–∂–∏–Ω–∫–∏
            for (let size of [16, 14, 12, 10]) {
                sprites.push(makeFlakeSprite(size));
            }
        }

        function initField() {
            const H = canvas.clientHeight;
            const offset = cssPx('--ground-offset', 0);
            groundY = H - offset;
            binW = 4;
            bins = Math.ceil(canvas.clientWidth / binW);
            heightmap = new Array(bins).fill(0);
        }

        function spawnFlakes() {
            const area = canvas.clientWidth * canvas.clientHeight;
            let n;
            
            // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Å–ª–∞–±—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            if (isLowEndDevice) {
                n = Math.max(50, Math.min(120, Math.floor(area / 20000)));
            } else if (isMobile) {
                n = Math.max(80, Math.min(180, Math.floor(area / 12000)));
            } else {
                n = Math.max(100, Math.min(240, Math.floor(area / 10000)));
            }
            
            const H = canvas.clientHeight;
            
            flakes = new Array(n).fill(0).map(() => {
                const config = flakeTypes['normal']; // –¢–æ–ª—å–∫–æ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ
                
                return {
                    x: Math.random() * canvas.clientWidth,
                    y: -Math.random() * H,
                    r: config.minSize + Math.random() * (config.maxSize - config.minSize),
                    vy: config.speed + Math.random() * 30,
                    swayA: config.sway + Math.random() * 15,
                    theta: Math.random() * Math.PI * 2,
                    swaySpeed: 0.8 + Math.random() * 1.6,
                    type: 'normal',
                    opacity: 0.7 + Math.random() * 0.3,
                    spin: (Math.random() - 0.5) * 0.03,
                    sprite: sprites[Math.floor(Math.random() * sprites.length)]
                };
            });
        }

        function fieldYAt(x) {
            const idx = Math.max(0, Math.min(bins-1, Math.floor(x / binW)));
            const x0 = idx * binW;
            const x1 = Math.min((idx + 1) * binW, bins * binW);
            const h0 = heightmap[idx] || 0;
            const h1 = heightmap[Math.min(idx + 1, bins - 1)] || 0;
            const t = (x - x0) / Math.max(1, (x1 - x0));
            const h = h0 * (1 - t) + h1 * t;
            return groundY - h;
        }

        function addSnowAt(x, amount) {
            const idx = Math.max(0, Math.min(bins - 1, Math.floor(x / binW)));
            const spread = 2;
            for (let k = -spread; k <= spread; k++) {
                const i = idx + k;
                if (i < 0 || i >= bins) continue;
                const w = 1 - Math.abs(k) / (spread + 1);
                heightmap[i] = Math.min(groundY * 0.5, heightmap[i] + amount * w);
            }
        }

        function updateSnow(dt) {
            if (!state.snowEnabled) return;

            for (const f of flakes) {
                f.theta += f.swaySpeed * dt;
                const vx = Math.sin(f.theta) * f.swayA;
                f.y += f.vy * dt;
                f.x += vx * dt;

                if (f.x < -8) f.x = canvas.clientWidth + 8;
                if (f.x > canvas.clientWidth + 8) f.x = -8;

                const yTop = fieldYAt(f.x);
                if (f.y + f.r >= yTop) {
                    addSnowAt(f.x, 1.2 + f.r * 0.9);
                    f.x = Math.random() * canvas.clientWidth;
                    f.y = -10 - Math.random() * canvas.clientHeight * 0.4;
                    f.theta = Math.random() * Math.PI * 2;
                }
            }

            for (let i = spray.length - 1; i >= 0; i--) {
                const p = spray[i];
                p.vy += 1200 * dt;
                p.x += p.vx * dt;
                p.y += p.vy * dt;
                p.life -= dt;
                if (p.life <= 0 || p.y >= fieldYAt(p.x)) {
                    spray.splice(i, 1);
                }
            }

            for (let i = 1; i < bins - 1; i++) {
                const avg = (heightmap[i-1] + heightmap[i] + heightmap[i+1]) / 3;
                heightmap[i] = heightmap[i] * 0.97 + avg * 0.03;
            }
        }

        /* ========== –û–¢–†–ò–°–û–í–ö–ê –≠–§–§–ï–ö–¢–û–í ========== */
        function renderVideo(targetCtx) {
            try {
                targetCtx.drawImage(video, 0, 0, canvas.clientWidth, canvas.clientHeight);
            } catch (_) {}
            targetCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            targetCtx.fillRect(0, 0, canvas.clientWidth, canvas.clientHeight);
        }

        function drawDrifts(targetCtx) {
            if (!state.driftsEnabled) return;
            
            const W = canvas.clientWidth;
            const H = canvas.clientHeight;
            targetCtx.save();
            
            const grad = targetCtx.createLinearGradient(0, groundY - 80, 0, groundY + 10);
            grad.addColorStop(0, 'rgba(255, 255, 255, 0.98)');
            grad.addColorStop(1, 'rgba(255, 255, 255, 0.86)');
            targetCtx.fillStyle = grad;

            targetCtx.beginPath();
            targetCtx.moveTo(0, H);
            targetCtx.lineTo(0, groundY - (heightmap[0] || 0));
            
            for (let i = 1; i < bins; i++) {
                const x = i * binW;
                const y = groundY - (heightmap[i] || 0);
                targetCtx.lineTo(x, y);
            }
            
            targetCtx.lineTo(W, H);
            targetCtx.closePath();
            targetCtx.fill();
            targetCtx.restore();
        }

        function drawFlakes(targetCtx) {
            if (!state.snowEnabled) return;
            
            for (const f of flakes) {
                targetCtx.save();
                targetCtx.globalAlpha = f.opacity;
                targetCtx.translate(f.x, f.y);
                targetCtx.rotate(f.spin * performance.now() / 1000);
                
                const s = f.sprite;
                const size = f.r * 2;
                targetCtx.drawImage(s, -f.r, -f.r, size, size);
                
                targetCtx.restore();
            }
        }

        function drawSpray(targetCtx) {
            for (const p of spray) {
                targetCtx.globalAlpha = Math.max(0, p.life / p.maxLife);
                targetCtx.beginPath();
                targetCtx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                targetCtx.fillStyle = 'white';
                targetCtx.fill();
            }
            targetCtx.globalAlpha = 1;
        }

        /* ========== –°–¢–ê–†–ê–Ø –°–ù–ï–ì–û–£–ë–û–†–û–ß–ù–ê–Ø –ú–ê–®–ò–ù–ê ========== */
        const plow = {
            active: false,
            auto: true,
            x: -200,
            dir: 1,
            speed: isLowEndDevice ? 200 : 280,
            width: 180,
            height: 70,
            blade: 130,
            lightsN: 5
        };

        function scheduleNextPlow(delayMs = 30000) {
            clearTimeout(nextPlowTimer);
            if (state.plowAutoEnabled && running) {
                nextPlowTimer = setTimeout(() => {
                    startPlowPass();
                }, delayMs);
            }
        }

        function startPlowPass() {
            if (plow.active || !running) return;
            plow.active = true;
            plow.dir = 1;
            plow.x = -plow.width - 80;
        }

        function updatePlow(dt) {
            if (!plow.active) return;
            
            plow.x += plow.speed * dt * plow.dir;

            // –ó–æ–Ω–∞ —á–∏—Å—Ç–∫–∏
            const center = plow.x + plow.width * 0.6;
            const w = plow.blade;
            const i0 = Math.max(0, Math.floor((center - w/2) / binW));
            const i1 = Math.min(bins - 1, Math.floor((center + w/2) / binW));

            for (let i = i0; i <= i1; i++) {
                const h = heightmap[i] || 0;
                if (h > 0) {
                    const take = Math.min(10.0, h);
                    heightmap[i] = Math.max(0, h - take);
                    
                    // –ß–∞—Å—Ç–∏—Ü—ã –æ—Ç —É–±–æ—Ä–∫–∏
                    for (let s = 0; s < (isLowEndDevice ? 1 : 3); s++) {
                        spray.push({
                            x: i * binW + Math.random() * binW,
                            y: fieldYAt(i * binW) - 6 - Math.random() * 8,
                            vx: (200 + Math.random() * 110) * plow.dir,
                            vy: -(220 + Math.random() * 140),
                            r: 1.0 + Math.random() * 1.6,
                            life: 0.45 + Math.random() * 0.55,
                            maxLife: 1.0
                        });
                    }
                }
            }

            if (plow.x > canvas.clientWidth + 80) {
                plow.active = false;
                scheduleNextPlow(30000);
            }
        }

        function drawPlow(targetCtx, t) {
            if (!plow.active) return;
            
            const W = plow.width;
            const H = plow.height;
            const y = groundY - Math.max(6, H * 0.1);
            
            targetCtx.save();
            targetCtx.translate(plow.x, y);

            // –¢–µ–Ω—å
            targetCtx.fillStyle = 'rgba(0, 0, 0, 0.25)';
            targetCtx.beginPath();
            targetCtx.ellipse(W * 0.35, 6, W * 0.38, 10, 0, 0, Math.PI * 2);
            targetCtx.fill();

            // –ö–æ—Ä–ø—É—Å
            targetCtx.fillStyle = '#e74c3c';
            targetCtx.strokeStyle = 'rgba(255, 255, 255, 0.25)';
            targetCtx.lineWidth = 2;

            targetCtx.beginPath();
            targetCtx.roundRect(0, -H, W * 0.7, H, 8);
            targetCtx.fill();
            targetCtx.stroke();

            // –ö–∞–±–∏–Ω–∞
            targetCtx.fillStyle = '#3498db';
            targetCtx.beginPath();
            targetCtx.roundRect(W * 0.5, -H * 1.4, W * 0.4, H * 0.9, 8);
            targetCtx.fill();
            targetCtx.stroke();

            // –ö–æ–≤—à
            targetCtx.fillStyle = '#f1c40f';
            targetCtx.beginPath();
            targetCtx.moveTo(W * 0.7, -H * 0.4);
            targetCtx.lineTo(W * 0.9, -H);
            targetCtx.lineTo(W * 0.9, -H * 0.2);
            targetCtx.closePath();
            targetCtx.fill();

            // –ö–æ–ª—ë—Å–∞
            targetCtx.fillStyle = '#2c3e50';
            targetCtx.beginPath();
            targetCtx.arc(W * 0.2, -8, 12, 0, Math.PI * 2);
            targetCtx.arc(W * 0.6, -8, 12, 0, Math.PI * 2);
            targetCtx.fill();

            // –§–∞—Ä—ã
            const flashIntensity = Math.sin(t * 0.008) > 0 ? 1 : 0.6;
            targetCtx.fillStyle = `rgba(255, 200, 0, ${flashIntensity})`;
            targetCtx.beginPath();
            targetCtx.arc(W * 0.92, -H * 1.2, 6, 0, Math.PI * 2);
            targetCtx.fill();

            targetCtx.restore();
        }

        /* ========== –£–õ–£–ß–®–ï–ù–ò–ï 7: –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ/–∏—Å—á–µ–∑–∞–Ω–∏–µ ========== */
        function fadeElement(element, show, duration = 500) {
            return new Promise(resolve => {
                if (show) {
                    element.style.display = 'block';
                    setTimeout(() => {
                        element.style.opacity = '1';
                    }, 10);
                } else {
                    element.style.opacity = '0';
                    setTimeout(() => {
                        element.style.display = 'none';
                        resolve();
                    }, duration);
                }
                setTimeout(resolve, duration);
            });
        }

        /* ========== –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ –ê–ù–ò–ú–ê–¶–ò–ò ========== */
        function resize() {
            canvas.width = Math.floor(canvas.clientWidth * DPR);
            canvas.height = Math.floor(canvas.clientHeight * DPR);
            ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
            initField();
        }

        window.addEventListener('resize', resize);

        let lastT = performance.now();
        function loop(t) {
            if (!running) return;
            
            const dt = Math.min(0.05, (t - lastT) / 1000);
            lastT = t;

            updateSnow(dt);
            updatePlow(dt);

            ctx.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);
            renderVideo(ctx);

            drawDrifts(ctx);
            drawPlow(ctx, t);
            drawSpray(ctx);
            drawFlakes(ctx);

            requestAnimationFrame(loop);
        }

        /* ========== –£–õ–£–ß–®–ï–ù–ò–ï 8: –£–º–Ω—ã–π –∑–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã ========== */
        async function startApp() {
            try {
                startBtn.disabled = true;
                startBtn.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                loader.classList.add('active');
                loader.innerHTML = '<div style="font-size: 30px; margin-bottom: 10px;">üì∏</div><div>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–∞–º–µ—Ä–µ...</div>';

                const constraints = {
                    video: {
                        width: { ideal: isLowEndDevice ? 640 : 1280 },
                        height: { ideal: isLowEndDevice ? 480 : 720 }
                    },
                    audio: false
                };

                if (state.lastCamera === 'environment') {
                    constraints.video.facingMode = { ideal: 'environment' };
                } else {
                    constraints.video.facingMode = { ideal: 'user' };
                }

                let stream;
                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (error) {
                    console.log('–ü–µ—Ä–≤–∞—è –∫–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥—É—é:', error.message);
                    constraints.video.facingMode = constraints.video.facingMode.ideal === 'environment' 
                        ? { ideal: 'user' }
                        : { ideal: 'environment' };
                    
                    try {
                        stream = await navigator.mediaDevices.getUserMedia(constraints);
                        state.lastCamera = constraints.video.facingMode.ideal;
                        saveSettings();
                    } catch (secondError) {
                        constraints.video.facingMode = { ideal: 'user' };
                        delete constraints.video.width;
                        delete constraints.video.height;
                        stream = await navigator.mediaDevices.getUserMedia(constraints);
                    }
                }

                video.srcObject = stream;

                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        video.play().then(resolve);
                    };
                });

                resize();
                buildSprites();
                spawnFlakes();
                running = true;

                // –ü–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
                await fadeElement(permissionScreen, false);
                permissionScreen.style.display = 'none';
                
                await Promise.all([
                    fadeElement(brand, true),
                    fadeElement(controls, true),
                    fadeElement(snowman, state.snowmanEnabled)
                ]);
                
                loader.classList.remove('active');
                
                lastT = performance.now();
                requestAnimationFrame(loop);
                
                scheduleNextPlow(3000);

            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', err);
                loader.classList.remove('active');
                
                if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    alert('–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã.');
                } else if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    alert('–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.');
                } else if (err.name === 'NotSupportedError') {
                    alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Chrome, Firefox –∏–ª–∏ Safari.');
                } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                    alert('–ö–∞–º–µ—Ä–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –∫–∞–º–µ—Ä—É.');
                } else {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ: ' + err.message);
                }
                
                startBtn.disabled = false;
                startBtn.textContent = '–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ';
            }
        }

        /* ========== –£–õ–£–ß–®–ï–ù–ò–ï 9: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è iOS ========== */
        const pointers = new Map();
        let dragId = null;
        let dragStartX = 0, dragStartY = 0;
        let startTx = 0, startTy = 0;
        let startScale = 1;
        let startDist = 0;
        let isDragging = false;

        // –£—Å—Ç–∞–Ω–æ–≤–∏–º –Ω–∞—á–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± —Å–Ω–µ–≥–æ–≤–∏–∫–∞ –Ω–∞ 150%
        snowman.style.setProperty('--s', '1.5');

        if (isIOS) {
            snowman.addEventListener('touchstart', handleTouchStart, { passive: false });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd);
            
            function handleTouchStart(e) {
                if (!running || snowman.style.display === 'none' || e.touches.length > 2) return;
                e.preventDefault();
                
                const touch = e.touches[0];
                pointers.set(touch.identifier, { x: touch.clientX, y: touch.clientY });
                
                const n = e.touches.length;
                const { tx, ty, s } = getTransform();
                
                if (n === 1) {
                    dragId = touch.identifier;
                    dragStartX = touch.clientX;
                    dragStartY = touch.clientY;
                    startTx = tx;
                    startTy = ty;
                    isDragging = true;
                    snowman.classList.add('dragging');
                } else if (n === 2) {
                    const t1 = e.touches[0];
                    const t2 = e.touches[1];
                    startScale = s;
                    startDist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY) || 1;
                    isDragging = false;
                    snowman.classList.remove('dragging');
                    dragId = null;
                }
            }
            
            function handleTouchMove(e) {
                if (!running || (!isDragging && e.touches.length !== 2)) return;
                e.preventDefault();
                
                const n = e.touches.length;
                const { tx, ty, s } = getTransform();
                
                if (n === 1 && isDragging) {
                    const touch = e.touches[0];
                    const dx = touch.clientX - dragStartX;
                    const dy = touch.clientY - dragStartY;
                    setTransform(startTx + dx, startTy + dy, s);
                } else if (n === 2) {
                    const t1 = e.touches[0];
                    const t2 = e.touches[1];
                    const dist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY) || 1;
                    const scale = clamp(startScale * (dist / startDist), 0.5, 2.5); // –£–≤–µ–ª–∏—á–∏–ª –º–∞–∫—Å–∏–º—É–º –¥–æ 250%
                    setTransform(tx, ty, scale);
                }
            }
            
            function handleTouchEnd(e) {
                isDragging = false;
                snowman.classList.remove('dragging');
                pointers.clear();
                dragId = null;
            }
            
        } else {
            snowman.addEventListener('pointerdown', handlePointerStart, { passive: false });
            
            function handlePointerStart(e) {
                if (!running || snowman.style.display === 'none') return;
                e.preventDefault();
                snowman.setPointerCapture(e.pointerId);
                pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });
                
                const n = pointers.size;
                const { tx, ty, s } = getTransform();
                
                if (n === 1) {
                    dragId = e.pointerId;
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                    startTx = tx;
                    startTy = ty;
                    snowman.classList.add('dragging');
                } else if (n === 2) {
                    startScale = s;
                    const [p1, p2] = Array.from(pointers.values());
                    startDist = Math.hypot(p2.x - p1.x, p2.y - p1.y) || 1;
                    snowman.classList.remove('dragging');
                    dragId = null;
                }
            }
            
            snowman.addEventListener('pointermove', (e) => {
                if (!pointers.has(e.pointerId)) return;
                e.preventDefault();
                pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });
                
                const n = pointers.size;
                const { tx, ty, s } = getTransform();
                
                if (n === 1 && dragId !== null) {
                    const cur = pointers.get(dragId);
                    const dx = cur.x - dragStartX;
                    const dy = cur.y - dragStartY;
                    setTransform(startTx + dx, startTy + dy, s);
                } else if (n === 2) {
                    const [p1, p2] = Array.from(pointers.values());
                    const dist = Math.hypot(p2.x - p1.x, p2.y - p1.y) || 1;
                    const scale = clamp(startScale * (dist / startDist), 0.5, 2.5); // –£–≤–µ–ª–∏—á–∏–ª –º–∞–∫—Å–∏–º—É–º –¥–æ 250%
                    setTransform(tx, ty, scale);
                }
            }, { passive: false });

            function endPointer(e) {
                if (pointers.has(e.pointerId)) pointers.delete(e.pointerId);
                if (e.pointerId === dragId) {
                    dragId = null;
                    snowman.classList.remove('dragging');
                }
                if (pointers.size === 1) {
                    const id = Array.from(pointers.keys())[0];
                    const pt = pointers.get(id);
                    const { tx, ty } = getTransform();
                    dragId = id;
                    dragStartX = pt.x;
                    dragStartY = pt.y;
                    startTx = tx;
                    startTy = ty;
                    snowman.classList.add('dragging');
                }
            }

            snowman.addEventListener('pointerup', endPointer, { passive: false });
            snowman.addEventListener('pointercancel', endPointer, { passive: false });
            snowman.addEventListener('pointerleave', endPointer, { passive: false });
        }

        function clamp(v, a, b) {
            return Math.max(a, Math.min(b, v));
        }

        function getTransform() {
            const st = getComputedStyle(snowman);
            return {
                tx: parseFloat(st.getPropertyValue('--tx')) || 0,
                ty: parseFloat(st.getPropertyValue('--ty')) || 0,
                s: parseFloat(st.getPropertyValue('--s')) || 1.5 // –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ 150%
            };
        }

        function setTransform(tx, ty, s) {
            snowman.style.setProperty('--tx', tx + 'px');
            snowman.style.setProperty('--ty', ty + 'px');
            snowman.style.setProperty('--s', s);
            
            const indicator = snowman.querySelector('.scale-indicator');
            indicator.textContent = Math.round(s * 100) + '%';
            indicator.style.display = 'block';
            setTimeout(() => indicator.style.display = 'none', 1000);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –º–∞—Å—à—Ç–∞–± –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            state.scale = s;
            saveSettings();
        }

        /* ========== –£–õ–£–ß–®–ï–ù–ò–ï 10: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫ ========== */
        function updateTogglesUI() {
            btnSnow.classList.toggle('is-on', state.snowEnabled);
            btnSnow.setAttribute('aria-pressed', String(state.snowEnabled));
            
            btnSnowman.classList.toggle('is-on', state.snowmanEnabled);
            btnSnowman.setAttribute('aria-pressed', String(state.snowmanEnabled));
            if (running) {
                snowman.style.display = state.snowmanEnabled ? 'block' : 'none';
            }
            
            btnMusic.classList.toggle('is-on', state.musicEnabled);
            btnMusic.setAttribute('aria-pressed', String(state.musicEnabled));
            
            btnDrifts.classList.toggle('is-on', state.driftsEnabled);
            btnDrifts.setAttribute('aria-pressed', String(state.driftsEnabled));
            
            btnPlow.classList.toggle('is-on', state.plowAutoEnabled);
            btnPlow.setAttribute('aria-pressed', String(state.plowAutoEnabled));
            
            // –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
            if (navigator.vibrate && isMobile) {
                try {
                    navigator.vibrate(10);
                } catch (e) {
                    console.log('–í–∏–±—Ä–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º UI –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
        updateTogglesUI();

        btnSnow.addEventListener('click', () => {
            state.snowEnabled = !state.snowEnabled;
            updateTogglesUI();
            saveSettings();
        });

        btnSnowman.addEventListener('click', () => {
            state.snowmanEnabled = !state.snowmanEnabled;
            updateTogglesUI();
            saveSettings();
        });

        btnMusic.addEventListener('click', toggleMusic);

        btnDrifts.addEventListener('click', () => {
            state.driftsEnabled = !state.driftsEnabled;
            updateTogglesUI();
            saveSettings();
        });

        btnPlow.addEventListener('click', () => {
            state.plowAutoEnabled = !state.plowAutoEnabled;
            updateTogglesUI();
            saveSettings();
            if (state.plowAutoEnabled && !plow.active) {
                scheduleNextPlow(1000);
            } else {
                clearTimeout(nextPlowTimer);
            }
        });

        /* ========== –£–õ–£–ß–®–ï–ù–ò–ï 11: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º ========== */
        let currentPhotoBlob = null;

        shotBtn.addEventListener('click', async () => {
            // –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫
            if (navigator.vibrate && isMobile) {
                try {
                    navigator.vibrate([30, 20, 30]);
                } catch (e) {}
            }
            
            // –í—Å–ø—ã—à–∫–∞
            flash.classList.add('active');
            setTimeout(() => flash.classList.remove('active'), 300);

            try {
                const W = canvas.clientWidth;
                const H = canvas.clientHeight;
                
                const shot = document.createElement('canvas');
                shot.width = Math.floor(W * CAPTURE_DPR);
                shot.height = Math.floor(H * CAPTURE_DPR);
                const sctx = shot.getContext('2d');
                sctx.setTransform(CAPTURE_DPR, 0, 0, CAPTURE_DPR, 0, 0);

                renderVideo(sctx);
                
                if (state.driftsEnabled) drawDrifts(sctx);
                if (plow.active) drawPlow(sctx, performance.now());
                drawSpray(sctx);
                if (state.snowEnabled) drawFlakes(sctx);
                
                if (state.snowmanEnabled && snowmanImg.complete) {
                    const rC = canvas.getBoundingClientRect();
                    const rM = snowman.getBoundingClientRect();
                    const mx = rM.left - rC.left;
                    const my = rM.top - rC.top;
                    const mw = rM.width;
                    const mh = rM.height;
                    const { s } = getTransform();
                    
                    sctx.save();
                    sctx.translate(mx + mw/2, my + mh/2);
                    sctx.scale(s, s);
                    sctx.drawImage(snowmanImg, -mw/2, -mh/2, mw, mh);
                    sctx.restore();
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–æ—Ç–∏–ø
                sctx.fillStyle = 'white';
                sctx.font = 'bold 16px Arial';
                sctx.textAlign = 'center';
                sctx.fillText('snowman496school.ru', W/2, H - 30);
                
                // –°–æ–∑–¥–∞–µ–º Blob –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                shot.toBlob(blob => {
                    currentPhotoBlob = blob;
                    const url = URL.createObjectURL(blob);
                    previewImage.src = url;
                    photoPreview.style.display = 'flex';
                }, 'image/png', 0.92);
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ—Ç–æ:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            }
        });

        saveBtn.addEventListener('click', () => {
            if (!currentPhotoBlob) return;
            
            const now = new Date();
            const pad = n => String(n).padStart(2, '0');
            const fname = `snowman496_${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}.png`;
            
            const url = URL.createObjectURL(currentPhotoBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fname;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 1000);
            
            photoPreview.style.display = 'none';
            if (previewImage.src) {
                URL.revokeObjectURL(previewImage.src);
                previewImage.src = '';
            }
            currentPhotoBlob = null;
        });

        cancelBtn.addEventListener('click', () => {
            photoPreview.style.display = 'none';
            if (previewImage.src) {
                URL.revokeObjectURL(previewImage.src);
                previewImage.src = '';
            }
            currentPhotoBlob = null;
        });

        /* ========== –£–õ–£–ß–®–ï–ù–ò–ï 12: –ó–∞–≥—Ä—É–∑–∫–∞ —Å–Ω–µ–≥–æ–≤–∏–∫–∞ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º ========== */
        snowmanImg.onload = () => {
            console.log('–°–Ω–µ–≥–æ–≤–∏–∫ –∑–∞–≥—Ä—É–∂–µ–Ω');
            snowmanImg.style.opacity = '1';
        };

        snowmanImg.onerror = () => {
            console.warn('–û—Å–Ω–æ–≤–Ω–æ–π —Å–Ω–µ–≥–æ–≤–∏–∫ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º SVG-–∑–∞–º–µ–Ω—É');
            const svgString = `data:image/svg+xml,${encodeURIComponent(`
                <svg width="225" height="300" viewBox="0 0 150 200" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="75" cy="150" r="40" fill="white" filter="url(#shadow)"/>
                    <circle cx="75" cy="85" r="30" fill="white" filter="url(#shadow)"/>
                    <circle cx="75" cy="40" r="20" fill="white" filter="url(#shadow)"/>
                    <circle cx="65" cy="35" r="3" fill="black"/>
                    <circle cx="85" cy="35" r="3" fill="black"/>
                    <path d="M75 45 Q75 50 70 52" stroke="orange" stroke-width="2" fill="none"/>
                    <circle cx="75" cy="60" r="2" fill="black"/>
                    <circle cx="75" cy="70" r="2" fill="black"/>
                    <defs>
                        <filter id="shadow">
                            <feDropShadow dx="2" dy="2" stdDeviation="2" flood-opacity="0.3"/>
                        </filter>
                    </defs>
                </svg>
            `)}`;
            snowmanImg.src = svgString;
        };

        // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –º–µ–¥–∏–∞
        snowmanImg.style.opacity = '0.5';
        snowmanImg.style.transition = 'opacity 0.3s';
        initAudio();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        startBtn.addEventListener('click', startApp);
    </script>
</body>
</html>
